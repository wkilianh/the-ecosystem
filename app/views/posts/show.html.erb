<div class="container">
  <div class="post-box">

    <div id="post-headline">
      <span id="post-title"><h1><%= @post.title %></h1></span>
      <% @post.ratings.first != nil ? rating = @post.ratings.first.avg : rating = 0 %>
      <span id="stars"><%= render "/shared/stars", rating: rating %>
        <span id="views">(<%= @post.ratings.count %>)</span>
      </span>
    </div><br>

    <div class="post-core">
      <% if @post.photos.attached? %>
        <%= cl_image_tag @post.photos.last.key, height: 300, width: 400, crop: :fill %><br>
      <% else %>
        <%= image_tag "https://res.cloudinary.com/ddclrx1ajasdf/image/upload/v1614952509/placeholder_avatar/pexels-pixabay-56875_cdviyq.jpg", style: "height: 300px" %>
      <% end %>
      <div class="list-head">
        <span><strong>Hack Expectations:</strong></span>
        <div><br></div>
        <div class="expectations"><span>CO2 Savings: </span><span><em><%= @post.expect_co2 %></em></span></div>
        <div class="expectations"><span>Waste Reduction: </span><span><em><%= @post.expect_waste %></em></span></div>
        <div class="expectations"><span>Resource Savings: </span><span><em><%= @post.expect_resources %></em></span></div>
        <div class="expectations"><span>DIY Effort: </span><span><em><%= @post.expect_diyeffort %></em></span></div>
        <div class="expectations"><span>Backfire Cost: </span><span><em><%= @post.expect_ecocost %></em></span></div>
      </div>
      <div class="single-ratings">
        <div><strong>Goals Met?</strong></div><br>
        <div class="single-stars"><%= render "/shared/stars", rating: @post.ratings.first != nil ? @post.ratings.first.co2 : 0 %></div>
        <div class="single-stars"><%= render "/shared/stars", rating: @post.ratings.first != nil ? @post.ratings.first.waste : 0 %></div>
        <div class="single-stars"><%= render "/shared/stars", rating: @post.ratings.first != nil ? @post.ratings.first.resources : 0 %></div>
        <div class="single-stars"><%= render "/shared/stars", rating: @post.ratings.first != nil ? @post.ratings.first.diyeffort : 0 %></div>
        <div class="single-stars"><%= render "/shared/stars", rating: @post.ratings.first != nil ? @post.ratings.first.ecocost : 0 %></div>
      </div>
    </div>

    <% if @post.user == current_user %>
      <div id="post-subline">
        <span><%= link_to "EDIT POST", edit_post_path(@post), class: "btn btn-panel" %></span>
        <p>You last updated this post at <%= @post.updated_at.strftime("%a, %b %e at %l:%M%p") %></p>
      </div>
    <% elsif current_user != nil && current_user.ratings.where(post_id: @post).exists? %>
      <div id="post-subline">
          <span><strong>You already rated this post at </strong><%= current_user.ratings.where(post_id: @post)[0].updated_at.strftime("%a, %b %e, %l:%M%p") %></span>
          <span>
            <p>Post created at <%= @post.updated_at.strftime("%a, %b %e, %l:%M%p") %> by </p><strong></strong><a href="<%= profile_path(@post.user) %>"><%= @post.user.nickname %><img src="<%= cl_image_path @post.user.prof_pic.key %>" class="avatar-post"/></a>
            <%= link_to '<i class="far fa-comments speech-bubbles"></i>'.html_safe, conversations_path(post_id: @post.id), method: :post %>
          </span>
      </div>
    <% else %>
      <div id="post-subline">
      <span><%= link_to "RATE POST", edit_post_path(@post), class: "btn btn-panel" %></span>
          <span>
            <%# @conversation.receiver = @post.user %>
            <p>Post created at <%= @post.updated_at.strftime("%a, %b %e, %l:%M%p") %> by </p><strong></strong><a href="<%= profile_path(@post.user) %>"> <%= @post.user.nickname %> <img src="<%= cl_image_path @post.user.prof_pic.key %>" class="avatar-post"/></a>
            <%= link_to '<i class="far fa-comments speech-bubbles"></i>'.html_safe, conversations_path(post_id: @post.id), method: :post %>
          </span>
      </div>

    <% end %>
  </div>
</div>


<%# <!-- Trigger/Open The Modal -->
<button id="myBtn">Open Modal</button>

<!-- The Modal -->
<div id="myModal" class="modal" style="background:none;">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span >
    <div id="inject-page"></div>
  </div>

</div> %>


<div class="container w-50">
  <div class="post-box">
    <div>
      <%= render layout: "layouts/action_text/contents/content" do %>
        <%= @post.rich_body %>
      <% end %>
    </div>
  </div>
</div>

<div class="container w-50">

  <br><br>

  <div id="comments">

    <div><h4>Comments</h4></div>

    <%= simple_form_for [@post, @comment] do |f| %>
      <%= f.input :content, label: false %>
      <%= f.submit "Leave a comment",class: "btn btn-panel" %>
    <% end %>

    <% @post.comments.each do |comment|%>
      <%= render "comment", comment: comment %>
      
      <div style="display: none" id=<%= "comment#{comment.id}" %>>
        <%= simple_form_for @reply do |f| %>
          <%= f.input :content, label: false %>
          <%= hidden_field_tag(:comment_id, comment.id) %>
          <% if user_signed_in? %>
            <%= hidden_field_tag(:user_id, current_user.id) %> 
          <% end %>
          <%= f.submit "reply",class: "btn btn-panel" %>
        <% end %>
      </div>

      <% comment.replies.each do |reply| %>
      <% if user_signed_in? %>
        <%= render 'reply', reply: reply %>
      <% end %>
      
      <% end %>
    <% end %>
  </div>

</div>

<script>
function reply(commentId) {
  var x = document.getElementById(commentId);
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}

</script>


<%# 
<script>
// Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
  modal.style.display = "block";
  page = document.getElementById('inject-page')

  fetch('/conversations/')
    .then(function(response) {
        // When the page is loaded convert it to text
        return response.text()
    })
    .then(function(html) {
        // Initialize the DOM parser
        var parser = new DOMParser();

        // Parse the text
        var doc = parser.parseFromString(html, "text/html");

        // You can now even select part of that html as you would in the regular DOM 
        // Example:
        // var docArticle = doc.querySelector('article').innerHTML;
        doc.children[0].children[1].children[0].remove()
        data = doc.children[0].children[1]
        page.innerHTML = ""
        page.insertAdjacentHTML('beforeend', data.innerHTML)
    })
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
</script>



<script>
  function clearText() {
    var sentMsg = document.querySelector('.form-control')
    if (sentMsg){
      sentMsg.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
          sentMsg.value = ""
        }
      });
    }
  }
  
  
  // left << this user's msg   other user's msg >> right
  function display(){
    console.log("run")
    nickname = document.getElementById('nickname').innerText
    document.querySelectorAll(".message-container").forEach(elm =>{
      if (elm.children[0] !== undefined){
        if(elm.children[0].children[0].children[0].innerHTML !== nickname){
          if (elm.children[0].style.float !== "right"){
            elm.children[0].style.float = "left"
          }
          
        }
      } 
    })
  }

  document.addEventListener('change', (event) => {
    clearText()
  });

display();
  
</script> %>